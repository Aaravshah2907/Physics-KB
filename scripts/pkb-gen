#!/bin/bash
# pkb-gen: Uses gemini-cli to generate deep-dive physics notes.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

TOPIC="$1"
if [ -z "$TOPIC" ]; then
    echo "Usage: pkb-gen <Topic Name>"
    exit 1
fi

# Step 1: Redundancy Check
draw_task_progress 1 4 "Redundancy check"
EXISTING_FILES=$(find "$NOTES_DIR" -name "*.md" -maxdepth 1 -exec basename {} \;)

if [ -n "$EXISTING_FILES" ]; then
    CHECK_PROMPT="Given these existing physics notes:
[$EXISTING_FILES]

Evaluate the redundancy of the new topic '$TOPIC'.
If it is highly related to an existing note (similarity score 1-100), output: FILENAME|SCORE.
If it deserves its own note, output: NONE|0.
Example: 'maxwells-equations.md|95'
Use a high threshold for score. No extra text."

    MATCH_RAW=$(call_gemini "$CHECK_PROMPT" | grep -iv "NONE" | grep -oE "[a-z0-9'-]+\.md\|[0-9]+")
    
    if [ -n "$MATCH_RAW" ]; then
        MATCH_FILE=$(echo "$MATCH_RAW" | cut -d'|' -f1)
        MATCH_SCORE=$(echo "$MATCH_RAW" | cut -d'|' -f2)
        
        if [ "$MATCH_SCORE" -ge 80 ]; then
            printf "\r\033[K   ðŸ’¡ High similarity ($MATCH_SCORE%%). Re-routing to refine $MATCH_FILE...\n" >&2
            cleanup_todo "$TOPIC"
            "$PKB_SCRIPTS_DIR/pkb-refine" "$MATCH_FILE" "Incorporate a deep-dive section on '$TOPIC'."
            exit $?
        else
            printf "\r\033[K   ðŸ”Ž Low similarity ($MATCH_SCORE%%). Proceeding with new note.\n" >&2
        fi
    fi
fi

# Step 2: Architecture
draw_task_progress 2 4 "Defining architecture"
SUGGESTED_NAME=$(call_gemini "Suggest a short lowercase-kebab-case filename for '$TOPIC'.")
FILE_NAME=$(sanitize_filename "$SUGGESTED_NAME")
[ -z "$FILE_NAME" ] && FILE_NAME=$(sanitize_filename "$TOPIC")
OUTPUT_FILE="$NOTES_DIR/$FILE_NAME.md"

# Step 3: Multi-Phase Generation (Skeleton Builder)
draw_task_progress 3 5 "Designing structure"
SYSTEM_PROMPT=$(cat "$GEMINI_CONF")
EXISTING_NOTES=$(get_existing_notes_list)
AVAILABLE_IMAGES=$(get_available_images)

# Extract context if topic was found in pkb-todo's list
TOPIC_CONTEXT=""
if [ -f "$TODO_FILE" ]; then
    CONTEXT_LINE=$(grep "^$TOPIC|" "$TODO_FILE" | head -1)
    if [ -n "$CONTEXT_LINE" ]; then
        SOURCE_FILE=$(echo "$CONTEXT_LINE" | cut -d'|' -f2)
        TOPIC_CONTEXT="Relationship: This topic relates to '$SOURCE_FILE.md'."
    fi
fi

# Phase 1: The Blueprint
OUTLINE_PROMPT="SYSTEM INSTRUCTIONS:
$SYSTEM_PROMPT
CONTEXT:
Existing topics: [$EXISTING_NOTES]
$TOPIC_CONTEXT

TASK:
Create a detailed, research-grade OUTLINE for the topic '$TOPIC'.
1. Use the 'Logical Development Score' (100-1) strategy.
2. Return ONLY a list of headings (H1, H2, H3), starting with the main Title as H1.
3. Do not include any content, just the structure.
4. Ensure the structure covers: Fundamentals, Mathematical Formalism, Intuition, Key Derivations, Applications, and History.

Output Format:
# Title
## Section 1
## Section 2
...
"

OUTLINE=$(call_gemini "$OUTLINE_PROMPT")

if [ -z "$OUTLINE" ]; then
    echo -e "\r\033[K   âŒ Outline generation failed." >&2
    exit 1
fi

# Initialize output file with YAML metadata (generated from outline title)
TITLE=$(echo "$OUTLINE" | grep "^# " | head -1 | sed 's/# //')
[ -z "$TITLE" ] && TITLE="$TOPIC"

cat <<EOF > "$OUTPUT_FILE"
---
title: "$TITLE"
tags: [physics]
date: $(date +%Y-%m-%d)
complexity: advanced
---

# $TITLE

Summary: This note explores the core principles of $TITLE, delving into its mathematical foundations and physical consequences.

EOF

# Phase 2: Iterative Expansion
# Extract H2 headings to generate content section by section
SECTIONS=$(echo "$OUTLINE" | grep "^## " | sed 's/## //')
TOTAL_SECTIONS=$(echo "$SECTIONS" | wc -l | tr -d ' ')
CURRENT_SEC=0

IFS=$'\n'
for SECTION_TITLE in $SECTIONS; do
    CURRENT_SEC=$((CURRENT_SEC + 1))
    draw_task_progress 3 5 "Writing: $SECTION_TITLE"
    
    SECTION_PROMPT="SYSTEM INSTRUCTIONS:
$SYSTEM_PROMPT
CONTEXT:
Topic: $TITLE
Current Section: '$SECTION_TITLE'
Full Outline:
$OUTLINE

TASK:
Write the complete content for the section '## $SECTION_TITLE'.
1. Include detailed mathematical derivations, physical intuition, and diagrams/simulations where relevant.
2. Use LaTeX for all math.
3. Use the search tools to inject real DOI/arXiv references if discussing key papers.
4. If a dynamic system is involved, include a Python simulation block.
5. If local images are missing, find Wikipedia diagram links.
6. Output ONLY the content for this section (start with '## $SECTION_TITLE'). Do not repeat the main title.
"
    
    SECTION_CONTENT=$(call_gemini "$SECTION_PROMPT")
    echo "" >> "$OUTPUT_FILE"
    echo "$SECTION_CONTENT" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
done
unset IFS

if [ -s "$OUTPUT_FILE" ]; then
    # Step 4: Finalizing
    draw_task_progress 4 5 "Indexing & polishing"
    
    # Use pkb-refine to smooth transitions (light pass)
    # create a temporary instruction to smooth connections between sections
    "$PKB_SCRIPTS_DIR/pkb-refine" "$OUTPUT_FILE" "Ensure smooth transitions between the separately generated sections. Remove any redundant intro/outro text from the sub-sections."
    
    draw_task_progress 5 5 "Assets & Links"
    download_external_images "$OUTPUT_FILE"
    extract_simulations "$OUTPUT_FILE"
    sync_backlinks "$OUTPUT_FILE"
    cleanup_todo "$TOPIC"
    git_snapshot "Generate deep-dive: $TOPIC"
    echo -e "\r\033[K   âœ… Saved to $FILE_NAME.md" >&2
else
    echo -e "\r\033[K   âŒ Generation failed." >&2
    exit 1
fi
