#!/bin/bash
# pkb-gen: Uses gemini-cli to generate deep-dive physics notes.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

# Parse optional flags
WITH_CODE=false
SKIP_CHECK=false
TAGS="[physics]"
TOPIC=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --with-code)
            WITH_CODE=true
            shift
            ;;
        --skip-check)
            SKIP_CHECK=true
            shift
            ;;
        --tags)
            TAGS="$2"
            shift 2
            ;;
        *)
            TOPIC="$1"
            shift
            ;;
    esac
done

if [ -z "$TOPIC" ]; then
    echo "Usage: pkb-gen <Topic Name> [--with-code] [--skip-check] [--tags \"[tag1, tag2]\"]"
    echo "  --with-code: Generate simulation code for dynamic systems"
    echo "  --skip-check: Skip redundancy/similarity analysis"
    echo "  --tags: Custom tags (default: [physics])"
    exit 1
fi

# Step 1: Redundancy Check (Optional)
if [ "$SKIP_CHECK" = false ]; then
    draw_task_progress 1 4 "Redundancy check"
    EXISTING_FILES=$(find "$NOTES_DIR" -name "*.md" -maxdepth 1 -exec basename {} \;)

    if [ -n "$EXISTING_FILES" ]; then
        CHECK_PROMPT=$(cat <<EOF
Given these existing physics notes:
$(get_project_context)

Evaluate the redundancy of the new topic '$TOPIC'.
If it is highly related to an existing note (similarity score 1-100), output: FILENAME|SCORE.
If it deserves its own note, output: NONE|0.
Example: 'maxwells-equations.md|95'
Use a high threshold for score. No extra text.
EOF
)

        MATCH_RAW=$(call_llm_light "$CHECK_PROMPT" | grep -iv "NONE" | grep -oE "[a-z0-9'-]+\.md\|[0-9]+")
        
        if [ -n "$MATCH_RAW" ]; then
            MATCH_FILE=$(echo "$MATCH_RAW" | cut -d'|' -f1)
            MATCH_SCORE=$(echo "$MATCH_RAW" | cut -d'|' -f2)
            
            if [ "$MATCH_SCORE" -ge 80 ]; then
                printf "\r\033[K   ðŸ’¡ High similarity ($MATCH_SCORE%%). Re-routing to refine $MATCH_FILE...\n" >&2
                cleanup_todo "$TOPIC"
                "$PKB_SCRIPTS_DIR/pkb-refine" "$MATCH_FILE" "Incorporate a deep-dive section on '$TOPIC'."
                exit $?
            else
                printf "\r\033[K   ðŸ”Ž Low similarity ($MATCH_SCORE%%). Proceeding with new note.\n" >&2
            fi
        fi
    fi
else
    draw_task_progress 1 4 "Skipping check"
    echo -e "\r\033[K   â© Context provided. Redundancy check skipped." >&2
fi

# Step 2: Architecture
draw_task_progress 2 4 "Defining architecture"
SUGGESTED_NAME=$(call_llm_light "Suggest a short lowercase-kebab-case filename for '$TOPIC'. Return ONLY the filename.md.")
FILE_NAME=$(sanitize_filename "$SUGGESTED_NAME")
[ -z "$FILE_NAME" ] && FILE_NAME=$(sanitize_filename "$TOPIC")
OUTPUT_FILE="$NOTES_DIR/$FILE_NAME.md"

# Step 3: Multi-Phase Generation (Skeleton Builder)
draw_task_progress 3 5 "Designing structure"
SYSTEM_PROMPT=$(cat "$GEMINI_CONF")
KNOWLEDGE_CONTEXT=$(get_project_context)
AVAILABLE_IMAGES=$(get_available_images)

# Extract context if topic was found in pkb-todo's list
TOPIC_CONTEXT=""
if [ -f "$TODO_FILE" ]; then
    CONTEXT_LINE=$(grep "^$TOPIC|" "$TODO_FILE" | head -1)
    if [ -n "$CONTEXT_LINE" ]; then
        SOURCE_FILE=$(echo "$CONTEXT_LINE" | cut -d'|' -f2)
        TOPIC_CONTEXT="Relationship: This topic relates to '$SOURCE_FILE.md'."
    fi
fi

# Phase 1: The Blueprint
OUTLINE_TASK=$(cat "$PROMPTS_DIR/gen_outline.txt" | sed "s/\${TOPIC}/$TOPIC/g")
OUTLINE_PROMPT=$(cat <<EOF
SYSTEM INSTRUCTIONS:
$SYSTEM_PROMPT
CONTEXT:
$KNOWLEDGE_CONTEXT
$TOPIC_CONTEXT

$OUTLINE_TASK
EOF
)

OUTLINE=$(call_gemini "$OUTLINE_PROMPT")

if [ -z "$OUTLINE" ]; then
    echo -e "\r\033[K   âŒ Outline generation failed." >&2
    exit 1
fi

# Initialize output file with YAML metadata (generated from outline title)
TITLE=$(echo "$OUTLINE" | grep "^# " | head -1 | sed 's/# //')
[ -z "$TITLE" ] && TITLE="$TOPIC"

generate_yaml_header "$TITLE" "$TAGS" > "$OUTPUT_FILE"
cat <<EOF >> "$OUTPUT_FILE"

# $TITLE

Summary: This note explores the core principles of $TITLE, delving into its mathematical foundations and physical consequences.

EOF

# Phase 2: Iterative Expansion
# Extract H2 headings to generate content section by section
SECTIONS=$(echo "$OUTLINE" | grep "^## " | sed 's/## //')
TOTAL_SECTIONS=$(echo "$SECTIONS" | wc -l | tr -d ' ')
CURRENT_SEC=0

IFS=$'\n'
for SECTION_TITLE in $SECTIONS; do
    CURRENT_SEC=$((CURRENT_SEC + 1))
    draw_task_progress $CURRENT_SEC $TOTAL_SECTIONS "Section $CURRENT_SEC/$TOTAL_SECTIONS: ${SECTION_TITLE:0:40}"
    
    CODE_INST=""
    if [ "$WITH_CODE" = true ]; then
        CODE_INST="4. If a dynamic system is involved, include a Python simulation block using the format: ---SIMULATION:python:filename.py---"
    fi

    SECTION_TASK=$(cat "$PROMPTS_DIR/gen_section.txt" | \
        sed "s/\${SECTION_TITLE}/$SECTION_TITLE/g" | \
        sed "s/\${CODE_INSTRUCTION}/$CODE_INST/g")
    
    SECTION_PROMPT=$(cat <<EOF
SYSTEM INSTRUCTIONS:
$SYSTEM_PROMPT
CONTEXT:
Topic: $TITLE
Current Section: '$SECTION_TITLE'
Full Outline:
$OUTLINE

$SECTION_TASK
EOF
)
    
    SECTION_CONTENT=$(call_gemini "$SECTION_PROMPT")
    echo "" >> "$OUTPUT_FILE"
    echo "$SECTION_CONTENT" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
done
unset IFS

if [ -s "$OUTPUT_FILE" ]; then
    # Step 4: Finalizing
    draw_task_progress 4 5 "Indexing & polishing"
    
    # Use pkb-refine to smooth transitions (light pass)
    "$PKB_SCRIPTS_DIR/pkb-refine" "$OUTPUT_FILE" "Ensure smooth transitions between the separately generated sections. Remove any redundant intro/outro text from the sub-sections."
    
    draw_task_progress 5 5 "Assets & Links"
    download_external_images "$OUTPUT_FILE"
    if [ "$WITH_CODE" = true ]; then
        extract_simulations "$OUTPUT_FILE"
    fi
    sync_backlinks "$OUTPUT_FILE"
    cleanup_todo "$TOPIC"
    git_snapshot "Generate deep-dive: $TOPIC"
    
    # Update Index and Todo List (unless in batch mode)
    if [ -z "$PKB_IN_BATCH" ]; then
        "$PKB_SCRIPTS_DIR/pkb-index" >/dev/null 2>&1
        "$PKB_SCRIPTS_DIR/pkb-todo" --update-only >/dev/null 2>&1
    fi
    
    echo -e "\r\033[K   âœ… Saved to $FILE_NAME.md" >&2
else
    echo -e "\r\033[K   âŒ Generation failed." >&2
    exit 1
fi
