#!/bin/bash
# pkb-gen: Uses gemini-cli to generate deep-dive physics notes.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

TOPIC="$1"
if [ -z "$TOPIC" ]; then
    echo "Usage: pkb-gen <Topic Name>"
    exit 1
fi

# Step 1: Redundancy Check
draw_task_progress 1 4 "Redundancy check"
EXISTING_FILES=$(find "$NOTES_DIR" -name "*.md" -maxdepth 1 -exec basename {} \;)

if [ -n "$EXISTING_FILES" ]; then
    CHECK_PROMPT="Given these existing physics notes:
[$EXISTING_FILES]

Evaluate the redundancy of the new topic '$TOPIC'.
If it is highly related to an existing note (similarity score 1-100), output: FILENAME|SCORE.
If it deserves its own note, output: NONE|0.
Example: 'maxwells-equations.md|95'
Use a high threshold for score. No extra text."

    MATCH_RAW=$(call_gemini "$CHECK_PROMPT" | grep -iv "NONE" | grep -oE "[a-z0-9'-]+\.md\|[0-9]+")
    
    if [ -n "$MATCH_RAW" ]; then
        MATCH_FILE=$(echo "$MATCH_RAW" | cut -d'|' -f1)
        MATCH_SCORE=$(echo "$MATCH_RAW" | cut -d'|' -f2)
        
        if [ "$MATCH_SCORE" -ge 80 ]; then
            printf "\r\033[K   ðŸ’¡ High similarity ($MATCH_SCORE%%). Re-routing to refine $MATCH_FILE...\n" >&2
            cleanup_todo "$TOPIC"
            "$PKB_SCRIPTS_DIR/pkb-refine" "$MATCH_FILE" "Incorporate a deep-dive section on '$TOPIC'."
            exit $?
        else
            printf "\r\033[K   ðŸ”Ž Low similarity ($MATCH_SCORE%%). Proceeding with new note.\n" >&2
        fi
    fi
fi

# Step 2: Architecture
draw_task_progress 2 4 "Defining architecture"
SUGGESTED_NAME=$(call_gemini "Suggest a short lowercase-kebab-case filename for '$TOPIC'.")
FILE_NAME=$(sanitize_filename "$SUGGESTED_NAME")
[ -z "$FILE_NAME" ] && FILE_NAME=$(sanitize_filename "$TOPIC")
OUTPUT_FILE="$NOTES_DIR/$FILE_NAME.md"

# Step 3: Generation
draw_task_progress 3 4 "Generating content"
SYSTEM_PROMPT=$(cat "$GEMINI_CONF")
EXISTING_NOTES=$(get_existing_notes_list)
AVAILABLE_IMAGES=$(get_available_images)

# Extract context if topic was found in pkb-todo's list
TOPIC_CONTEXT=""
if [ -f "$TODO_FILE" ]; then
    CONTEXT_LINE=$(grep "^$TOPIC|" "$TODO_FILE" | head -1)
    if [ -n "$CONTEXT_LINE" ]; then
        SOURCE_FILE=$(echo "$CONTEXT_LINE" | cut -d'|' -f2)
        TOPIC_CONTEXT="Relationship: This topic relates to '$SOURCE_FILE.md'."
    fi
fi

FULL_PROMPT="SYSTEM INSTRUCTIONS:
$SYSTEM_PROMPT
CONTEXT:
Existing topics: [$EXISTING_NOTES]
Available images: [$AVAILABLE_IMAGES]
$TOPIC_CONTEXT

TASK:
Generate a comprehensive, research-grade physics note on '$TOPIC'.
1. Use a 'Logical Development Score' (1-100) to structure the note:
   - High Score (100-80): Summaries, fundamental definitions, and core physical intuition.
   - Mid Score (79-40): Mathematical formalism, derivations, and primary consequences.
   - Low Score (39-1): Specialized applications, edge cases, and historical context.
   Order sections strictly descending by score (Fundamentals first).
2. Ensure all LaTeX is correct and backlinks are logically placed.
3. If relevant local images are missing from the context, use your tools to find a high-quality historical or conceptual diagram link from Wikipedia.
4. Use your tools to adding a 'References' section with real, clickable DOI/arXiv links for key papers.
5. Output ONLY raw markdown content. Start with YAML metadata."

call_gemini "$FULL_PROMPT" > "$OUTPUT_FILE"

if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
    # Step 4: Finalizing
    draw_task_progress 4 4 "Indexing links"
    download_external_images "$OUTPUT_FILE"
    extract_simulations "$OUTPUT_FILE"
    sync_backlinks "$OUTPUT_FILE"
    cleanup_todo "$TOPIC"
    git_snapshot "Generate note: $TOPIC"
    echo -e "\r\033[K   âœ… Saved to $FILE_NAME.md" >&2
else
    echo -e "\r\033[K   âŒ Generation failed." >&2
    exit 1
fi
