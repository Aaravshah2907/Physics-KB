#!/bin/bash
# pkb-stats: Generates a high-level dashboard of the Physics Knowledge Base.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

echo -e "${CYAN}üìä PHYSICS-KB DASHBOARD${RESET}"
echo -e "${CYAN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${RESET}"

# 1. General Metrics
TOTAL_NOTES=$(find "$NOTES_DIR" -maxdepth 1 -name "*.md" | wc -l | tr -d ' ')
TOTAL_IMAGES=$(find "$ASSETS_IMG_DIR" -type f | wc -l | tr -d ' ' 2>/dev/null || echo 0)
PENDING_TOPICS=$(wc -l < "$TODO_FILE" | tr -d ' ' 2>/dev/null || echo 0)

echo -e "${BOLD}üìÅ Library Size:${RESET}"
printf "   %-20s %d\n" "Total Notes:" "$TOTAL_NOTES"
printf "   %-20s %d\n" "Local Images:" "$TOTAL_IMAGES"
printf "   %-20s %d\n" "Pending Topics:" "$PENDING_TOPICS"
echo ""

# 2. Complexity Distribution
COMPLEXITIES=$(grep "^complexity:" "$NOTES_DIR"/*.md 2>/dev/null | cut -d':' -f3 | tr -d ' ' | tr '[:upper:]' '[:lower:]' | sort | uniq -c)

echo -e "${BOLD}üöÄ Complexity Distribution:${RESET}"
while read -r LINE; do
    COUNT=$(echo "$LINE" | awk '{print $1}')
    LEVEL=$(echo "$LINE" | awk '{print $2}')
    PERCENT=$(( 100 * COUNT / TOTAL_NOTES ))
    printf "   %-15s %3d (%d%%) [" "$LEVEL" "$COUNT" "$PERCENT"
    BAR_LEN=$(( PERCENT / 5 ))
    printf "${GREEN}%${BAR_LEN}s${RESET}" | tr ' ' '‚îÅ'
    REMAIN=$(( 20 - BAR_LEN ))
    printf "%${REMAIN}s" | tr ' ' ' '
    echo "]"
done <<< "$COMPLEXITIES"
echo ""

# 3. Knowledge Health & Decay
echo -e "${BOLD}üìâ Knowledge Health:${RESET}"

# Stale Notes (Modified > 90 days ago)
if [[ "$OSTYPE" == "darwin"* ]]; then
    STALE_COUNT=$(find "$NOTES_DIR" -name "*.md" -mtime +90 | wc -l | tr -d ' ')
else
    STALE_COUNT=$(find "$NOTES_DIR" -name "*.md" -mtime +90 | wc -l)
fi
printf "   %-25s ${YELLOW}%d${RESET}\n" "Stale Notes (>3 months):" "$STALE_COUNT"

# Orphaned Notes (Zero inbound links)
ALL_BASENAMES=$(find "$NOTES_DIR" -maxdepth 1 -name "*.md" -exec basename {} .md \;)
LINKED_TOPICS=$(grep -rEoh "\[\[[^]]+\]\]" "$NOTES_DIR" | sed -E 's/\[\[([^]|#]+).*\]\]/\1/' | sort -u)
ORPHAN_COUNT=0

for BASE in $ALL_BASENAMES; do
    if ! echo "$LINKED_TOPICS" | grep -q "^$BASE$"; then
        ORPHAN_COUNT=$((ORPHAN_COUNT + 1))
    fi
done
printf "   %-25s ${RED}%d${RESET}\n" "Orphaned Notes:" "$ORPHAN_COUNT"
echo ""

# 4. Top Backlinked "Power Nodes"
echo -e "${BOLD}üîó Top Power Nodes (Most Backlinked):${RESET}"
BACKLINK_COUNTS=$(grep -rEoh "\[\[[^]]+\]\]" "$NOTES_DIR" | sed -E 's/\[\[([^]|#]+).*\]\]/\1/' | sort | uniq -c | sort -rn | head -5)

while read -r LINE; do
    COUNT=$(echo "$LINE" | awk '{print $1}')
    TOPIC=$(echo "$LINE" | cut -d' ' -f2-)
    printf "   %-25s %d links\n" "$TOPIC" "$COUNT"
done <<< "$BACKLINK_COUNTS"
echo ""

echo -e "${GREEN}‚ú® Knowledge Base analysis complete!${RESET}"
