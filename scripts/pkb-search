#!/bin/bash
# pkb-search: RAG-based search that queries local knowledge before answering.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

QUERY="$1"

if [ ! -d "$NOTES_DIR" ] || [ -z "$(ls -A "$NOTES_DIR")" ]; then
    echo "‚ùå No notes found."
    exit 1
fi

# 1. Browse Mode (No Query)
if [ -z "$QUERY" ]; then
    SELECTED_NAME=$(find "$NOTES_DIR" -maxdepth 1 -name "*.md" -exec basename {} \; | fzf --height 40% --layout=reverse --border --preview "grep -E '^#+' $NOTES_DIR/{} | bat --color=always --style=plain --language markdown")
    if [ -n "$SELECTED_NAME" ]; then
        echo -e "\n\033[1;34müìñ Outline of $SELECTED_NAME:\033[0m"
        grep -E '^#+' "$NOTES_DIR/$SELECTED_NAME" | bat --color=always --style=plain --language markdown
    fi
    exit 0
fi

echo -e "\033[1;36müß† Searching local Physics-KB for: '$QUERY'...\033[0m"

# 2. Retrieval Phase (RAG)
# Find top 3 relevant files using grep scores
RETRIEVED_CONTEXT=""
SEARCH_RESULTS=$(grep -riIl "$QUERY" "$NOTES_DIR" | head -n 3)

if [ -n "$SEARCH_RESULTS" ]; then
    for FILE in $SEARCH_RESULTS; do
        CONTENT=$(grep -iC 5 "$QUERY" "$FILE" | head -n 20)
        RETRIEVED_CONTEXT+="--- From $(basename "$FILE") ---\n$CONTENT\n\n"
    done
fi

# 3. Generation Phase
ANSWER_PROMPT="You are the Physics KB Assistant. Use the following retrieved local context to answer the user's query.

LOCAL KB CONTEXT:
$RETRIEVED_CONTEXT

USER QUERY: $QUERY

INSTRUCTIONS:
- Answer the query accurately based on the physics in your local KB.
- If the local KB doesn't have the info, say 'According to my general knowledge...' but prioritize local context.
- Mention which files you are referencing.
- Format with LaTeX.

Output the answer or say no relevant notes found. No tools."

echo -e "\033[1;33müí° AI Answer:\033[0m"
call_gemini "$ANSWER_PROMPT"
echo -e "\n\033[1;36m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\033[0m"

# 4. Interactive selection
echo -e "\033[1mSelect a note to open (Filtered by relevance):\033[0m"
FILE_LIST=$(find "$NOTES_DIR" -name "*.md" -maxdepth 1 -exec basename {} \;)
RANKED_FILES=$(call_gemini "Based on query '$QUERY', rank these: [$FILE_LIST]. Output filenames only." | grep ".md")

SELECTED_NAME=$(echo "$RANKED_FILES" | fzf --height 40% --layout=reverse --border --preview "grep -E '^#+' $NOTES_DIR/{} | bat --color=always --style=plain --language markdown")

if [ -n "$SELECTED_NAME" ]; then
    echo -e "\n\033[1;34müìñ Outline of $SELECTED_NAME:\033[0m"
    grep -E '^#+' "$NOTES_DIR/$SELECTED_NAME" | bat --color=always --style=plain --language markdown
fi
