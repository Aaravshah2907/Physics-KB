#!/bin/bash
# pkb-search: Index-based search with focused viewing using bat

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

INDEX_JSON="$PROJ_ROOT/topic_index.json"

# Check dependencies
if ! command -v jq &> /dev/null; then
    echo "âŒ Error: jq is required. Install with: brew install jq"
    exit 1
fi

if ! command -v bat &> /dev/null; then
    echo "âŒ Error: bat is required. Install with: brew install bat"
    exit 1
fi

if ! command -v fzf &> /dev/null; then
    echo "âŒ Error: fzf is required. Install with: brew install fzf"
    exit 1
fi

# Ensure index exists
if [ ! -f "$INDEX_JSON" ]; then
    echo "âš ï¸  Index not found. Generating..."
    "$SCRIPT_DIR/pkb-index"
fi

QUERY="$1"

# Function to display topic with bat at specific line
view_topic() {
    local file="$1"
    local line="$2"
    local title="$3"
    
    echo -e "\n\033[1;34mðŸ“– Viewing: $title\033[0m"
    echo -e "\033[0;36m   File: $file (line $line)\033[0m\n"
    
    # Use bat with line highlighting
    bat --color=always \
        --style=numbers,grid \
        --highlight-line "$line" \
        --line-range "$line:" \
        "$NOTES_DIR/$(basename "$file")"
}

# Browse Mode (No Query) - Show all topics hierarchically
if [ -z "$QUERY" ]; then
    echo -e "\033[1;36mðŸ“š Browse Physics KB Topics\033[0m"
    echo ""
    
    # Build searchable list: "File > Topic Path (line X)"
    TOPICS=$(jq -r '
    def flatten_topics(path; file):
        if .children and (.children | length) > 0 then
            (.children[] | flatten_topics(path + " > " + .title; file)),
            {file: file, path: (path + " > " + .title), line: .line, title: .title}
        else
            {file: file, path: (path + " > " + .title), line: .line, title: .title}
        end;
    
    .files[] | 
    .hierarchy[] as $topic |
    flatten_topics(.title; .path) |
    .file + " â”‚ " + .path + " â”‚ L" + (.line|tostring)
    ' "$INDEX_JSON")
    
    # Use fzf for selection with preview
    SELECTED=$(echo "$TOPICS" | fzf \
        --height 80% \
        --layout=reverse \
        --border \
        --prompt="ðŸ” Search topics: " \
        --preview-window=right:60% \
        --preview 'FILE=$(echo {} | cut -d"â”‚" -f1 | xargs); LINE=$(echo {} | cut -d"â”‚" -f3 | sed "s/L//"); bat --color=always --style=numbers --highlight-line $LINE --line-range $((LINE > 5 ? LINE - 5 : 1)):$((LINE + 20)) "'"$NOTES_DIR"'/$FILE"')
    
    if [ -n "$SELECTED" ]; then
        FILE=$(echo "$SELECTED" | cut -d'â”‚' -f1 | xargs)
        TITLE=$(echo "$SELECTED" | cut -d'â”‚' -f2 | xargs)
        LINE=$(echo "$SELECTED" | cut -d'â”‚' -f3 | sed 's/L//' | xargs)
        
        view_topic "$FILE" "$LINE" "$TITLE"
    fi
    exit 0
fi

# Search Mode - Find topics matching query
echo -e "\033[1;36mðŸ” Searching for: '$QUERY'\033[0m"
echo ""

# Search in topic titles and file content
MATCHING_TOPICS=$(jq -r --arg query "$QUERY" '
def flatten_topics(path; file):
    if .children and (.children | length) > 0 then
        (.children[] | flatten_topics(path + " > " + .title; file)),
        {file: file, path: (path + " > " + .title), line: .line, title: .title}
    else
        {file: file, path: (path + " > " + .title), line: .line, title: .title}
    end;

.files[] | 
.hierarchy[] as $topic |
flatten_topics(.title; .path) |
select(.title | ascii_downcase | contains($query | ascii_downcase)) |
.file + " â”‚ " + .path + " â”‚ L" + (.line|tostring)
' "$INDEX_JSON")

if [ -z "$MATCHING_TOPICS" ]; then
    echo "âŒ No topics found matching '$QUERY'"
    echo ""
    echo "ðŸ’¡ Searching file content instead..."
    
    # Fall back to grep search
    GREP_RESULTS=$(grep -rn "$QUERY" "$NOTES_DIR"/*.md 2>/dev/null | head -20)
    
    if [ -z "$GREP_RESULTS" ]; then
        echo "âŒ No results found in file content either."
        exit 1
    fi
    
    # Format grep results for fzf
    SEARCH_RESULTS=$(echo "$GREP_RESULTS" | while IFS=: read -r file line content; do
        filename=$(basename "$file")
        echo "$filename â”‚ $content â”‚ L$line"
    done)
    
    SELECTED=$(echo "$SEARCH_RESULTS" | fzf \
        --height 80% \
        --layout=reverse \
        --border \
        --prompt="ðŸ“„ Content matches: " \
        --preview-window=right:60% \
        --preview 'FILE=$(echo {} | cut -d"â”‚" -f1 | xargs); LINE=$(echo {} | cut -d"â”‚" -f3 | sed "s/L//"); bat --color=always --style=numbers --highlight-line $LINE --line-range $((LINE > 5 ? LINE - 5 : 1)):$((LINE + 20)) "'"$NOTES_DIR"'/$FILE"')
    
    if [ -n "$SELECTED" ]; then
        FILE=$(echo "$SELECTED" | cut -d'â”‚' -f1 | xargs)
        CONTENT=$(echo "$SELECTED" | cut -d'â”‚' -f2 | xargs)
        LINE=$(echo "$SELECTED" | cut -d'â”‚' -f3 | sed 's/L//' | xargs)
        
        view_topic "$FILE" "$LINE" "$CONTENT"
    fi
else
    echo -e "\033[1;32mâœ“ Found matching topics\033[0m"
    echo ""
    
    # Use fzf for selection
    SELECTED=$(echo "$MATCHING_TOPICS" | fzf \
        --height 80% \
        --layout=reverse \
        --border \
        --prompt="ðŸ“‘ Select topic: " \
        --preview-window=right:60% \
        --preview 'FILE=$(echo {} | cut -d"â”‚" -f1 | xargs); LINE=$(echo {} | cut -d"â”‚" -f3 | sed "s/L//"); bat --color=always --style=numbers --highlight-line $LINE --line-range $((LINE > 5 ? LINE - 5 : 1)):$((LINE + 20)) "'"$NOTES_DIR"'/$FILE"')
    
    if [ -n "$SELECTED" ]; then
        FILE=$(echo "$SELECTED" | cut -d'â”‚' -f1 | xargs)
        TITLE=$(echo "$SELECTED" | cut -d'â”‚' -f2 | xargs)
        LINE=$(echo "$SELECTED" | cut -d'â”‚' -f3 | sed 's/L//' | xargs)
        
        view_topic "$FILE" "$LINE" "$TITLE"
    fi
fi
