#!/bin/bash
# pkb-export: Converts Obsidian notes into a publication-ready LaTeX/PDF using Pandoc.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

if ! command -v pandoc &> /dev/null; then
    echo -e "${RED}âŒ Error: pandoc is not installed.${RESET}"
    echo "Install with: brew install pandoc"
    exit 1
fi

echo -e "${BLUE}ðŸ“„ PHYSICS-KB EXPORT ENGINE${RESET}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"

# Selection
SELECTED=$(find "$NOTES_DIR" -maxdepth 1 -name "*.md" -exec basename {} \; | fzf \
    --height 60% \
    --layout=reverse \
    --border \
    --multi \
    --prompt="ðŸ“‘ Select notes to export (TAB to multi-select): " \
    --header="Press ENTER to start export" \
    --preview "bat --color=always '$NOTES_DIR/{}'")

if [ -z "$SELECTED" ]; then
    echo "No files selected."
    exit 0
fi

# Ask for output format
echo "Output Formats:"
echo "  [1] LaTeX (.tex)"
echo "  [2] PDF (.pdf) - Requires pdflatex/XeLaTeX"
echo "  [3] Markdown (.md) - Consolidated"
read -p "Select format [1-3]: " FORMAT_CHOICE

OUT_EXT="pdf"
case $FORMAT_CHOICE in
    1) OUT_EXT="tex" ;;
    2) OUT_EXT="pdf" ;;
    3) OUT_EXT="md" ;;
esac

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
FINAL_OUT="$EXPORTS_DIR/physics_export_$TIMESTAMP.$OUT_EXT"

draw_task_progress 1 2 "Processing notes"
CONSOLIDATED="$EXPORTS_DIR/temp_merge.md"
> "$CONSOLIDATED"

while read -r FILE; do
    echo -e "\n\r\033[K   âž• Adding: $FILE"
    # Append content but strip YAML and add a page break for LaTeX
    echo -e "\n\c" >> "$CONSOLIDATED"
    sed '1,/^---$/d' "$NOTES_DIR/$FILE" >> "$CONSOLIDATED"
    echo -e "\n\newpage\n" >> "$CONSOLIDATED"
done <<< "$SELECTED"

draw_task_progress 2 2 "Generating $OUT_EXT"
if [ "$OUT_EXT" == "md" ]; then
    mv "$CONSOLIDATED" "$FINAL_OUT"
else
    # LaTeX template or standard conversion
    pandoc "$CONSOLIDATED" -o "$FINAL_OUT" \
        --from markdown+tex_math_dollars \
        --toc \
        --number-sections \
        -V geometry:margin=1in \
        -V fontsize=12pt \
        --pdf-engine=pdflatex
    
    rm -f "$CONSOLIDATED"
fi

if [ $? -eq 0 ]; then
    echo -e "\n${GREEN}âœ… Export successful!${RESET}"
    echo -e "ðŸ“ File: $FINAL_OUT"
else
    echo -e "\n${RED}âŒ Pandoc conversion failed.${RESET}"
    [ -f "$CONSOLIDATED" ] && rm "$CONSOLIDATED"
fi
