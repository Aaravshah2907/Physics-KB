#!/bin/bash
# pkb-todo: Scans for missing topics linked in existing notes, updates a list, and provides an fzf interface to generate them.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

if [ ! -d "$NOTES_DIR" ]; then
    echo "‚ùå Notes directory not found at $NOTES_DIR"
    exit 1
fi

echo "üîç Scanning for missing topics (excluding References)..."

# 1. Get all normalized existing filenames
EXISTING_NORM=$(find "$NOTES_DIR" -maxdepth 1 -name "*.md" -exec basename {} \; | sed 's/\.md$//' | tr '[:upper:]' '[:lower:]' | sed "s/[^a-z0-9]//g" | sort -u)

# 2. Extract all topics from links [[Topic]] or [[Topic|Alias]] across all files
ALL_LINKS=""
while read -r FILE; do
    LINKS=$(extract_links_filtered "$FILE")
    ALL_LINKS+="$LINKS"$'\n'
done < <(find "$NOTES_DIR" -maxdepth 1 -name "*.md")

RAW_LINKS=$(echo "$ALL_LINKS" | sort -u)

MISSING_WITH_CONTEXT=""
while read -r TOPIC; do
    [ -z "$TOPIC" ] && continue
    [[ "$TOPIC" == *"'"* ]] || [[ "$TOPIC" == *'"'* ]] && continue
    NORM_TOPIC=$(sanitize_filename "$TOPIC" | tr -d '-')
    
    if ! echo "$EXISTING_NORM" | grep -qx "$NORM_TOPIC"; then
        # Find all files linking to this topic
        MATCHES=$(grep -lF "[[$TOPIC]]" "$NOTES_DIR"/*.md)
        COUNT=$(echo "$MATCHES" | wc -l | tr -d ' ')
        SOURCE=$(echo "$MATCHES" | head -1 | xargs basename 2>/dev/null | sed 's/\.md//')
        
        MISSING_WITH_CONTEXT+="$TOPIC|$SOURCE|$COUNT"$'\n'
    fi
done <<< "$RAW_LINKS"

# 3. Update the 'additional topics' file (case-insensitive deduplication)
if [ -n "$MISSING_WITH_CONTEXT" ]; then
    echo -n "$MISSING_WITH_CONTEXT" | sort -f -t'|' -k1,1 -u > "$TODO_FILE"
    COUNT=$(wc -l < "$TODO_FILE" | tr -d ' ')
    echo "üìù Updated $TODO_FILE with $COUNT missing topics (context saved)."
else
    > "$TODO_FILE"
    echo "‚ú® No missing topics found!"
fi

# 4. FZF selection
if [ "$1" == "--update-only" ]; then
    exit 0
fi

if [ ! -s "$TODO_FILE" ]; then
    exit 0
fi

if command -v fzf &> /dev/null; then
    # Show Topic and Link Count in FZF
    SELECTED_LINE=$(awk -F'|' '{printf "%-40s (%s links) -> Source: %s\n", $1, $3, $2}' "$TODO_FILE" | \
        fzf --height 50% --layout=reverse --border \
            --prompt="Select a topic to handle: " \
            --header="Missing Topics (Select to Generate or Refine)" \
            --preview "echo {}" --preview-window=down:1)
    
    if [ -n "$SELECTED_LINE" ]; then
        # Extract topic: everything before the first " ("
        TOPIC=$(echo "$SELECTED_LINE" | sed 's/ ([0-9]* links).*//' | sed 's/[[:space:]]*$//')
        
        # We need to look up the source file and count correctly from the file based on topic
        # Because we formatted the output, extraction is tricky. Let's direct grep the TODO_FILE.
        
        # Use awk for exact field matching to avoid partial matches
        DATA=$(awk -F'|' -v t="$TOPIC" '$1 == t {print $0; exit}' "$TODO_FILE")
        SOURCE=$(echo "$DATA" | cut -d'|' -f2)
        COUNT=$(echo "$DATA" | cut -d'|' -f3)

        
        if [ "$COUNT" -eq 1 ]; then
            echo ""
            echo "üí° Topic '$TOPIC' is only linked from '$SOURCE'."
            echo "Do you want to:"
            echo "  [G]enerate a new standalone note (Default)"
            echo "  [R]efine '$SOURCE' to include this topic"
            read -p "Select [G/r]: " -n 1 -r CHOICE
            echo ""
            
            if [[ "$CHOICE" =~ ^[Rr]$ ]]; then
                "$PKB_SCRIPTS_DIR/pkb-refine" "$SOURCE" "Add a section explaining '$TOPIC' in detail."
                exit 0
            fi
        fi
        
        # Default / Multiple Links -> Generate New
        echo "üöÄ Triggering generation for: $TOPIC"
        "$PKB_SCRIPTS_DIR/pkb-gen" "$TOPIC" --skip-check
    fi
else
    echo "fzf not found. Install it for interactive selection."
fi
