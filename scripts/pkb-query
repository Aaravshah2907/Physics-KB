#!/bin/bash
# pkb-query: Query the topic index with various filters

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJ_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
INDEX_JSON="$PROJ_ROOT/topic_index.json"

if ! command -v jq &> /dev/null; then
    echo "‚ùå Error: jq is required. Install with: brew install jq"
    exit 1
fi

if [ ! -f "$INDEX_JSON" ]; then
    echo "‚ùå Index not found. Run: pkb-index"
    exit 1
fi

# Parse command
CMD="$1"
ARG="$2"

case "$CMD" in
    stats|"")
        echo "üìä Index Statistics"
        echo "==================="
        echo ""
        echo "Total files: $(jq -r '.total_files' "$INDEX_JSON")"
        echo "Total topics: $(jq -r '.total_topics' "$INDEX_JSON")"
        echo "Avg topics/file: $(jq -r '(.total_topics / .total_files * 10 | round / 10)' "$INDEX_JSON")"
        echo ""
        echo "üìà Complexity Distribution:"
        jq -r '.files | group_by(.complexity) | .[] | "  " + (.[0].complexity | ascii_upcase | .[0:1]) + (.[0].complexity | .[1:]) + ": " + (length|tostring) + " files"' "$INDEX_JSON"
        echo ""
        echo "üè∑Ô∏è  Top Tags:"
        jq -r '.files | map(.tags[]) | group_by(.) | map({tag: .[0], count: length}) | sort_by(.count) | reverse | .[0:5] | .[] | "  " + .tag + ": " + (.count|tostring) + " files"' "$INDEX_JSON"
        echo ""
        echo "üìö Largest Files:"
        jq -r '.files | sort_by(.topic_count) | reverse | .[0:5] | .[] | "  " + .title + ": " + (.topic_count|tostring) + " topics"' "$INDEX_JSON"
        ;;
    
    tag)
        if [ -z "$ARG" ]; then
            echo "Usage: pkb-query tag <tag_name>"
            echo ""
            echo "Available tags:"
            jq -r '.files | map(.tags[]) | unique | .[] | "  - " + .' "$INDEX_JSON"
            exit 1
        fi
        echo "üìã Files tagged '$ARG':"
        jq -r --arg tag "$ARG" '.files[] | select(.tags[] | contains($tag)) | "  ‚Ä¢ " + .title + " (" + .path + ")"' "$INDEX_JSON"
        ;;
    
    complexity)
        if [ -z "$ARG" ]; then
            echo "Usage: pkb-query complexity <level>"
            echo "  Levels: basic, intermediate, advanced"
            exit 1
        fi
        echo "üìä Files with complexity '$ARG':"
        jq -r --arg comp "$ARG" '.files[] | select(.complexity == $comp) | "  ‚Ä¢ " + .title + " (" + (.topic_count|tostring) + " topics)"' "$INDEX_JSON"
        ;;
    
    find)
        if [ -z "$ARG" ]; then
            echo "Usage: pkb-query find <keyword>"
            exit 1
        fi
        echo "üîç Topics containing '$ARG':"
        jq -r --arg query "$ARG" "$JQ_FLATTEN_FILTER"'
        .files[] | 
        .hierarchy[] as $topic |
        flatten_topics(.title; .path) |
        select(.title | ascii_downcase | contains($query | ascii_downcase)) |
        "  ‚Ä¢ " + .path + " (line " + (.line|tostring) + ")"
        ' "$INDEX_JSON"
        ;;
    
    file)
        if [ -z "$ARG" ]; then
            echo "Usage: pkb-query file <filename.md>"
            exit 1
        fi
        echo "üìÑ Topics in '$ARG':"
        jq -r --arg file "$ARG" '
        def print_tree(indent):
            ("  " * indent) + "‚Ä¢ " + .title + " (L" + (.level|tostring) + ", line " + (.line|tostring) + ")",
            (.children[]? | print_tree(indent + 1));
        
        .files[] | select(.filename == $file) | .hierarchy[] | print_tree(0)
        ' "$INDEX_JSON"
        ;;
    
    largest)
        echo "üìö Largest Files (by topic count):"
        jq -r '.files | sort_by(.topic_count) | reverse | .[0:10] | .[] | "  " + (.topic_count|tostring) + " topics - " + .title' "$INDEX_JSON"
        ;;
    
    deepest)
        echo "üå≥ Deepest Hierarchies:"
        jq -r '.files | sort_by(.max_depth) | reverse | .[0:10] | .[] | "  " + (.max_depth|tostring) + " levels - " + .title' "$INDEX_JSON"
        ;;
    
    help|--help|-h)
        cat << 'HELP'
pkb-query - Query the Physics KB topic index

USAGE:
  pkb-query [command] [argument]

COMMANDS:
  stats              Show index statistics (default)
  tag <name>         List files with specific tag
  complexity <lvl>   List files by complexity (basic/intermediate/advanced)
  find <keyword>     Find topics containing keyword
  file <name.md>     Show topic tree for specific file
  largest            Show files with most topics
  deepest            Show files with deepest hierarchies
  help               Show this help message

STANDARD TAGS:
  physics, mechanics, electromagnetism, math, Relativity, 
  theoretical-physics, analytical-mechanics, kinematics.

EXAMPLES:
  pkb-query stats
  pkb-query tag electromagnetism
  pkb-query complexity advanced
  pkb-query find Lagrangian
  pkb-query file classical-mechanics.md
  pkb-query largest

HELP
        ;;
    
    *)
        echo "‚ùå Unknown command: $CMD"
        echo "Run 'pkb-query help' for usage information"
        exit 1
        ;;
esac
