#!/bin/bash
# pkb-bridge: Identifies semantic connections between notes and suggests new links.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/pkb-common.sh"

echo -e "${PURPLE}ðŸ¤– SEMANTIC BRIDGE GENERATOR${RESET}"
echo -e "${PURPLE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"

draw_task_progress 1 3 "Analyzing library structure"

# 1. Gather Titles and Summaries from index
INDEX_JSON="$PROJ_ROOT/topic_index.json"
if [ ! -f "$INDEX_JSON" ]; then
    draw_task_progress 1 3 "Indexing library..."
    "$PKB_SCRIPTS_DIR/pkb-index" >/dev/null 2>&1
fi

NOTE_DATA=$(jq -r '.files[] | "\(.filename)|\(.title)|\(.summary)|LINKS:[]"' "$INDEX_JSON")
# Note: LINKS:[] is a placeholder as full link extraction per file is better handled during generation or here if needed.
# But for semantic bridging, title and summary are usually enough.


# 2. Batch Analysis via Gemini
draw_task_progress 2 3 "Finding hidden connections"

BRIDGE_PROMPT="Given the following list of physics notes (Format: Filename|Title|Summary|ExistingLinks):

$NOTE_DATA

TASK:
Identify 5-10 HIGH-VALUE semantic connections that are currently MISSING in the 'ExistingLinks' of the source notes.
Focus on relationships where one concept provides the 'physical origin', 'mathematical foundation', or a 'direct consequence' of another.

Output ONLY in this format, one per line:
SOURCE_FILE|TARGET_FILE|REASON
Example: 'quantum-tunneling.md|alpha-decay.md|Tunneling is the physical mechanism behind alpha particle emission.'
No extra markers or conversational text."

TEMP_DIR=$(mktemp -d)
echo "" # For spinner
call_llm_light "$BRIDGE_PROMPT" > "$TEMP_DIR/suggestions.txt"

# 3. Interactive Application
draw_task_progress 3 3 "Reviewing suggestions"
echo ""

if [ ! -s "$TEMP_DIR/suggestions.txt" ]; then
    echo "âœ¨ No new high-value connections found. Your KB is well-linked!"
    rm -rf "$TEMP_DIR"
    exit 0
fi

# Filter for valid lines and display in fzf
SELECTED=$(grep "|" "$TEMP_DIR/suggestions.txt" | fzf --height 50% --layout=reverse --border \
    --prompt="Select a bridge to build: " \
    --header="Format: Source -> Target | Reason (Press ESC to cancel)")

if [ -n "$SELECTED" ]; then
    SRC_FILE=$(echo "$SELECTED" | cut -d'|' -f1)
    TGT_FILE=$(echo "$SELECTED" | cut -d'|' -f2)
    REASON=$(echo "$SELECTED" | cut -d'|' -f3)
    
    TGT_TITLE=$(extract_note_title "$NOTES_DIR/$TGT_FILE")

    echo -e "\nðŸš€ Building bridge: ${BLUE}$SRC_FILE${RESET} -> ${GREEN}$TGT_TITLE${RESET}"
    echo -e "ðŸ’¡ Context: $REASON\n"
    
    "$PKB_SCRIPTS_DIR/pkb-refine" "$SRC_FILE" "Add a contextual link to [[$TGT_TITLE]] because: $REASON. Ensure this link is integrated into the structural flow, not just appended."
fi

rm -rf "$TEMP_DIR"
